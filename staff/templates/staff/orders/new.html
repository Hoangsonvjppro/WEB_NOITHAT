{% extends 'staff/base_staff.html' %}

{% block title %}Tạo đơn hàng mới{% endblock %}

{% block page_title %}Tạo đơn hàng mới{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'staff:orders' %}">Đơn hàng</a></li>
<li class="breadcrumb-item active">Tạo mới</li>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .select2-container--bootstrap-5 .select2-selection {
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.75rem;
        height: auto;
        min-height: 38px;
    }
    .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    .line-total {
        min-width: 120px;
    }
    #products-container {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<form method="post" id="new-order-form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Customer Information -->
            <div class="card border-0 dashboard-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer" class="form-label">Khách hàng <span class="text-danger">*</span></label>
                            <select class="form-select select2" id="customer" name="customer" required>
                                <option value="">Chọn khách hàng</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.get_full_name }} ({{ customer.email }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="branch" class="form-label">Chi nhánh <span class="text-danger">*</span></label>
                            <select class="form-select" id="branch" name="branch" required>
                                <option value="">Chọn chi nhánh</option>
                                {% for branch in branches %}
                                <option value="{{ branch.id }}">{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="shipping_address" class="form-label">Địa chỉ giao hàng <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="shipping_address" name="shipping_address" rows="3" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="note" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="note" name="note" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Selection -->
            <div class="card border-0 dashboard-card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Sản phẩm</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus me-2"></i> Thêm sản phẩm
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table" id="products-table">
                            <thead>
                                <tr>
                                    <th width="50"></th>
                                    <th>Sản phẩm</th>
                                    <th>Đơn giá</th>
                                    <th width="120">Số lượng</th>
                                    <th>Thành tiền</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="product-entries">
                                <tr id="empty-product-message">
                                    <td colspan="6" class="text-center py-3">Chưa có sản phẩm nào được thêm.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card border-0 dashboard-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Tổng kết đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="cash">Tiền mặt</option>
                            <option value="bank_transfer">Chuyển khoản</option>
                            <option value="credit_card">Thẻ tín dụng</option>
                            <option value="momo">Ví MoMo</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_status" class="form-label">Trạng thái thanh toán <span class="text-danger">*</span></label>
                        <select class="form-select" id="payment_status" name="payment_status" required>
                            <option value="pending">Chưa thanh toán</option>
                            <option value="paid">Đã thanh toán</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shipping_fee" class="form-label">Phí vận chuyển</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="shipping_fee" name="shipping_fee" min="0" value="0" onchange="updateTotals()">
                            <span class="input-group-text">đ</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="discount" class="form-label">Giảm giá</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="discount" name="discount" min="0" value="0" onchange="updateTotals()">
                            <span class="input-group-text">đ</span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng sản phẩm:</span>
                        <span id="subtotal">0đ</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí vận chuyển:</span>
                        <span id="shipping-fee-display">0đ</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Giảm giá:</span>
                        <span id="discount-display">0đ</span>
                    </div>
                    
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Tổng cộng:</span>
                        <span id="total" class="text-primary">0đ</span>
                    </div>
                    
                    <input type="hidden" name="subtotal_amount" id="subtotal_amount" value="0">
                    <input type="hidden" name="total_amount" id="total_amount" value="0">
                </div>
                <div class="card-footer bg-white">
                    <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                        <i class="fas fa-check-circle me-2"></i> Tạo đơn hàng
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Thêm sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="product-search" placeholder="Tìm kiếm sản phẩm theo tên, mã SKU...">
                </div>
                
                <div id="products-container">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>SKU</th>
                                <th>Danh mục</th>
                                <th>Tồn kho</th>
                                <th>Giá</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-image="{{ product.main_image.url|default:'/static/images/default-product.png' }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ product.main_image.url|default:'/static/images/default-product.png' }}" class="product-image me-2">
                                        <span>{{ product.name }}</span>
                                    </div>
                                </td>
                                <td>{{ product.sku }}</td>
                                <td>{{ product.category.name }}</td>
                                <td>{{ product.quantity }}</td>
                                <td>{{ product.price|floatformat:0 }}đ</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary add-product-btn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // Initialize Select2
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap-5'
        });
        
        // Pre-populate shipping address when customer is selected
        $('#customer').change(function() {
            const customerId = $(this).val();
            if (customerId) {
                // In a real app, you would make an AJAX call to get customer data
                // For demo purposes, we'll leave this blank or use dummy data
            }
        });
        
        // Product search functionality
        $('#product-search').on('keyup', function() {
            const searchValue = $(this).val().toLowerCase();
            $('#products-container tbody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(searchValue) > -1);
            });
        });
        
        // Add product to order
        $('.add-product-btn').click(function() {
            const productRow = $(this).closest('tr');
            const productId = productRow.data('id');
            const productName = productRow.data('name');
            const productPrice = productRow.data('price');
            const productImage = productRow.data('image');
            
            // Check if product already exists in the order
            const existingProduct = $(`#product-${productId}`);
            if (existingProduct.length > 0) {
                // Increment quantity if product already exists
                const quantityInput = existingProduct.find('.product-quantity');
                const currentQuantity = parseInt(quantityInput.val());
                quantityInput.val(currentQuantity + 1);
                updateLineTotal(quantityInput);
            } else {
                // Add new product row
                $('#empty-product-message').hide();
                $('#product-entries').append(`
                    <tr id="product-${productId}">
                        <td>
                            <img src="${productImage}" class="product-image">
                        </td>
                        <td>
                            ${productName}
                            <input type="hidden" name="product_ids[]" value="${productId}">
                        </td>
                        <td>
                            <span class="product-price">${productPrice.toLocaleString('vi-VN')}đ</span>
                            <input type="hidden" name="prices[]" value="${productPrice}">
                        </td>
                        <td>
                            <input type="number" class="form-control product-quantity" name="quantities[]" min="1" value="1" onchange="updateLineTotal(this)">
                        </td>
                        <td>
                            <span class="line-total">${productPrice.toLocaleString('vi-VN')}đ</span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger remove-product-btn" onclick="removeProduct(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `);
            }
            
            // Update totals
            updateTotals();
            
            // Close modal
            $('#addProductModal').modal('hide');
        });
        
        // Form submission
        $('#new-order-form').submit(function(e) {
            const productCount = $('#product-entries tr').not('#empty-product-message').length;
            if (productCount === 0) {
                e.preventDefault();
                alert('Vui lòng thêm ít nhất một sản phẩm vào đơn hàng.');
                return false;
            }
            
            // Disable submit button to prevent double submission
            $('#submit-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Đang xử lý...');
            return true;
        });
    });
    
    // Update line total when quantity changes
    function updateLineTotal(quantityInput) {
        const quantity = parseInt($(quantityInput).val());
        const row = $(quantityInput).closest('tr');
        const priceElement = row.find('.product-price');
        const priceText = priceElement.text().replace('đ', '').replace(/\./g, '').trim();
        const price = parseInt(priceText);
        
        const lineTotal = price * quantity;
        row.find('.line-total').text(lineTotal.toLocaleString('vi-VN') + 'đ');
        
        updateTotals();
    }
    
    // Remove product from order
    function removeProduct(button) {
        const row = $(button).closest('tr');
        row.remove();
        
        // Show empty message if no products
        if ($('#product-entries tr').not('#empty-product-message').length === 0) {
            $('#empty-product-message').show();
        }
        
        updateTotals();
    }
    
    // Update order totals
    function updateTotals() {
        let subtotal = 0;
        
        // Calculate subtotal
        $('#product-entries tr').not('#empty-product-message').each(function() {
            const lineTotalText = $(this).find('.line-total').text().replace('đ', '').replace(/\./g, '').trim();
            const lineTotal = parseInt(lineTotalText);
            subtotal += lineTotal;
        });
        
        // Get shipping fee and discount
        const shippingFee = parseInt($('#shipping_fee').val()) || 0;
        const discount = parseInt($('#discount').val()) || 0;
        
        // Calculate total
        const total = subtotal + shippingFee - discount;
        
        // Update display
        $('#subtotal').text(subtotal.toLocaleString('vi-VN') + 'đ');
        $('#shipping-fee-display').text(shippingFee.toLocaleString('vi-VN') + 'đ');
        $('#discount-display').text(discount.toLocaleString('vi-VN') + 'đ');
        $('#total').text(total.toLocaleString('vi-VN') + 'đ');
        
        // Update hidden fields
        $('#subtotal_amount').val(subtotal);
        $('#total_amount').val(total);
    }
</script>
{% endblock %} 