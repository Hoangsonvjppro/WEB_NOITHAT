{% extends 'staff/base_staff.html' %}

{% block title %}Dashboard - Quản Lý Nội Thất{% endblock %}

{% block page_title %}Tổng Quan{% endblock %}

{% block content %}
<div class="row">
    <!-- Recent Stats Cards -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <span class="fa-stack fa-2x">
                            <i class="fas fa-circle fa-stack-2x text-primary-lighter"></i>
                            <i class="fas fa-shopping-cart fa-stack-1x text-primary"></i>
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ orders_today }}</h5>
                        <p class="text-muted mb-0">Đơn hàng hôm nay</p>
                    </div>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-primary" style="width: {{ orders_percentage }}%"></div>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    {% if orders_percentage >= 0 %}
                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>{{ orders_percentage }}%</span>
                    {% else %}
                    <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ orders_percentage|abs }}%</span>
                    {% endif %}
                    so với hôm qua
                </p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <span class="fa-stack fa-2x">
                            <i class="fas fa-circle fa-stack-2x text-success-lighter"></i>
                            <i class="fas fa-money-bill-wave fa-stack-1x text-success"></i>
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ revenue_today|floatformat:0 }}đ</h5>
                        <p class="text-muted mb-0">Doanh thu hôm nay</p>
                    </div>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: {{ revenue_percentage }}%"></div>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    {% if revenue_percentage >= 0 %}
                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>{{ revenue_percentage }}%</span>
                    {% else %}
                    <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ revenue_percentage|abs }}%</span>
                    {% endif %}
                    so với hôm qua
                </p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <span class="fa-stack fa-2x">
                            <i class="fas fa-circle fa-stack-2x text-warning-lighter"></i>
                            <i class="fas fa-users fa-stack-1x text-warning"></i>
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ new_customers }}</h5>
                        <p class="text-muted mb-0">Khách hàng mới (30 ngày)</p>
                    </div>
                </div>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-warning" style="width: {{ customer_percentage }}%"></div>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    {% if customer_percentage >= 0 %}
                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>{{ customer_percentage }}%</span>
                    {% else %}
                    <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ customer_percentage|abs }}%</span>
                    {% endif %}
                    so với tháng trước
                </p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0 me-3">
                        <span class="fa-stack fa-2x">
                            <i class="fas fa-circle fa-stack-2x text-info-lighter"></i>
                            <i class="fas fa-box fa-stack-1x text-info"></i>
                        </span>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ low_stock_count }}</h5>
                        <p class="text-muted mb-0">Sản phẩm sắp hết hàng</p>
                    </div>
                </div>
                <a href="{% url 'staff:inventory' %}" class="btn btn-sm btn-outline-info mt-3">Xem chi tiết</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sales Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Biểu đồ doanh thu</h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary active" data-period="week">7 ngày</button>
                    <button type="button" class="btn btn-outline-primary" data-period="month">30 ngày</button>
                    <button type="button" class="btn btn-outline-primary" data-period="year">Năm</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Products -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Sản phẩm bán chạy</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for product in top_products %}
                    <div class="list-group-item border-0 d-flex align-items-center py-3">
                        <div class="me-3">
                            <img src="{{ product.product.main_image.url|default:'/static/images/default-product.png' }}" alt="{{ product.product.name }}" class="rounded" width="40" height="40" style="object-fit: cover;">
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{ product.product.name }}</h6>
                            <small class="text-muted">{{ product.category }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success rounded-pill">{{ product.total_quantity }} đã bán</span>
                            <div class="text-muted small">{{ product.total_revenue|floatformat:0 }}đ</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">Chưa có dữ liệu.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Orders -->
    <div class="col-lg-7 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Đơn hàng gần đây</h5>
                <a href="{% url 'staff:orders' %}" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Trạng thái</th>
                                <th>Tổng tiền</th>
                                <th>Ngày tạo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>{{ order.order_number }}</td>
                                <td>{{ order.customer.get_full_name }}</td>
                                <td>
                                    {% if order.status == 'pending' %}
                                    <span class="badge bg-warning">Đang chờ</span>
                                    {% elif order.status == 'processing' %}
                                    <span class="badge bg-info">Đang xử lý</span>
                                    {% elif order.status == 'shipped' %}
                                    <span class="badge bg-primary">Đang giao</span>
                                    {% elif order.status == 'delivered' %}
                                    <span class="badge bg-success">Đã giao</span>
                                    {% elif order.status == 'cancelled' %}
                                    <span class="badge bg-danger">Đã hủy</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.total_amount|floatformat:0 }}đ</td>
                                <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'staff:order_detail' order.id %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted mb-0">Không có đơn hàng nào.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Status -->
    <div class="col-lg-5 mb-4">
        <div class="card border-0 dashboard-card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tình trạng kho hàng</h5>
                <a href="{% url 'staff:inventory' %}" class="btn btn-sm btn-outline-primary">Xem chi tiết</a>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <canvas id="stockStatusChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Còn hàng</span>
                                <span class="text-success">{{ stock_stats.in_stock }} sản phẩm</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: {{ stock_stats.in_stock_percent }}%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Sắp hết hàng</span>
                                <span class="text-warning">{{ stock_stats.low_stock }} sản phẩm</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: {{ stock_stats.low_stock_percent }}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Hết hàng</span>
                                <span class="text-danger">{{ stock_stats.out_of_stock }} sản phẩm</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: {{ stock_stats.out_of_stock_percent }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">Sản phẩm sắp hết hàng</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>SKU</th>
                                <th>Tồn kho</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>{{ product.sku }}</td>
                                <td><span class="text-warning">{{ product.quantity }}</span></td>
                                <td>
                                    <a href="{% url 'staff:stock_in_product' product.id %}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-plus-circle"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <p class="text-muted mb-0">Không có sản phẩm nào sắp hết hàng.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: {{ revenue_chart_labels|safe }},
                datasets: [{
                    label: 'Doanh thu',
                    data: {{ revenue_chart_data|safe }},
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    pointBackgroundColor: '#4e73df',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#4e73df',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.toLocaleString('vi-VN') + 'đ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + 'đ';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Stock Status Chart
        const stockStatusCtx = document.getElementById('stockStatusChart').getContext('2d');
        const stockStatusChart = new Chart(stockStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Còn hàng', 'Sắp hết hàng', 'Hết hàng'],
                datasets: [{
                    data: [
                        {{ stock_stats.in_stock }}, 
                        {{ stock_stats.low_stock }}, 
                        {{ stock_stats.out_of_stock }}
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#dc3545'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                cutout: '75%'
            }
        });
        
        // Period buttons for revenue chart
        document.querySelectorAll('[data-period]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('[data-period]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // In a real app, you would make AJAX call to get period data
                // For demo, we'll just show a message
                const period = this.getAttribute('data-period');
                console.log(`Fetching data for period: ${period}`);
                
                // Mock data update
                // In a real app, you would update the chart with new data from API
                if (period === 'week') {
                    // Weekly data (already loaded by default)
                } else if (period === 'month') {
                    // Monthly data
                } else if (period === 'year') {
                    // Yearly data
                }
            });
        });
    });
</script>
{% endblock %} 